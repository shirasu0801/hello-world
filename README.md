# Legend of the Hello World

8bit ファミコンスタイル RPG。C++ で書かれたゲームロジックを WebAssembly にコンパイルし、HTML5 Canvas + JavaScript で描画するハイブリッド構成のブラウザゲームです。

---

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| タイトル | Legend of the Hello World |
| ジャンル | ドラゴンクエスト風ターン制 RPG |
| プラットフォーム | デスクトップブラウザ（WebAssembly） |
| アートスタイル | 8bit ファミコン風（256x240 ピクセル） |
| ステージ数 | 全 3 ステージ（草原 → 溶岩洞窟 → 魔王城） |
| 敵の種類 | ザコ敵 10 種 + ボス 2 体 |
| 装備・アイテム | 武器 6 種 / 防具 6 種 / 消耗品 5 種 |

### 要件

- **ゲームエンジン（C++）**: キャラクターのステータス計算、戦闘ロジック（ダメージ計算）、所持品管理、衝突判定
- **UI/フロントエンド（HTML5 / CSS / JS）**: メニュー画面の表示、テキストのタイピング演出、ドット絵の描画、キー入力受付
- **通信/連携（WebAssembly）**: Emscripten の `emscripten::bind` で C++ の関数を JS から呼び出し、JSON 文字列でデータを同期

---

## 2. 技術スタック

| レイヤー | 技術 | 役割 |
|----------|------|------|
| バックエンド | C++17 | ゲームロジック全般 |
| コンパイラ | Emscripten (emcc) | C++ → WebAssembly 変換 |
| フロントエンド | HTML5 Canvas / CSS / JavaScript (ES Modules) | 描画・UI・入力 |
| 通信 | WASM Bridge (`emscripten::bind`) | C++ ↔ JS 間のデータ受け渡し（JSON 文字列） |
| 解像度 | 256x240 px（NES 準拠） | CSS `image-rendering: pixelated` で 768x720 に拡大 |

---

## 3. 事前準備

### 3.1 必要なソフトウェア

| ソフトウェア | バージョン | 用途 |
|-------------|-----------|------|
| **Emscripten SDK (emsdk)** | 5.0.0 以上 | C++ → WebAssembly コンパイル |
| **Python** | 3.10 以上 | Emscripten 実行 / ローカル HTTP サーバー |
| **Git Bash** (Windows) | - | ビルドスクリプト実行 |
| **ブラウザ** | Chrome / Firefox / Edge（最新版） | ゲーム実行 |

### 3.2 Emscripten SDK のインストール

```bash
# Windows の場合（C:\emsdk に配置済みと想定）
cd /c/emsdk
./emsdk install latest
./emsdk activate latest
```

インストール済みかの確認:

```bash
python /c/emsdk/upstream/emscripten/emcc.py --version
# => emcc (Emscripten gcc/clang-like replacement ...) 5.0.0
```

---

## 4. インストール・設定・実行手順

### 4.1 リポジトリの取得

```bash
git clone <repository-url>
cd hello-world
```

### 4.2 ビルド（C++ → WebAssembly）

```bash
bash build.sh
```

成功すると以下が生成されます:
- `web/wasm/game.js` — Emscripten グルーコード（約 28 KB）
- `web/wasm/game.wasm` — WASM バイナリ（約 160 KB）

### 4.3 ローカルサーバーの起動

WebAssembly は `file://` プロトコルでは動作しないため、HTTP サーバーが必要です。

```bash
python -m http.server 8888
```

### 4.4 ブラウザでアクセス

```
http://localhost:8888
```

タイトル画面が表示されたら **Enter キー** でゲーム開始です。

### 4.5 再ビルド時の手順

C++ のコードを修正した場合:

```bash
bash build.sh          # WASM を再コンパイル
# ブラウザをリロード（Ctrl+Shift+R でキャッシュクリアリロード推奨）
```

JS / CSS のみの修正はブラウザリロードだけで反映されます。

---

## 5. フォルダ構造と各ファイルの説明

```
hello-world/
├── index.html                   エントリポイント HTML
├── build.sh                     WASM ビルドスクリプト
├── .gitignore                   Git 除外設定
├── .claude.md                   Claude Code 用プロジェクト設定
├── README.md                    本ドキュメント
│
├── src/                         C++ ソースコード
│   ├── Player.h / Player.cpp    プレイヤークラス
│   ├── Enemy.h / Enemy.cpp      敵クラス（12 種の定義含む）
│   ├── Item.h / Item.cpp        アイテムデータベース（17 種の定義含む）
│   ├── Battle.h / Battle.cpp    戦闘ロジック
│   ├── Shop.h / Shop.cpp        ショップ売買・装備ロジック
│   ├── GameState.h / .cpp       ゲーム全体の状態管理
│   ├── MapData.h / MapData.cpp  3 ステージ分のタイルマップデータ
│   └── wasm/
│       └── Bridge.cpp           EMSCRIPTEN_BINDINGS（WASM ↔ JS 橋渡し）
│
├── web/                         フロントエンド
│   ├── css/
│   │   └── style.css            NES 風 CSS（黒背景、ピクセルレンダリング）
│   ├── js/
│   │   ├── main.js              ゲームループ・シーン管理
│   │   ├── constants.js         定数（解像度、色、タイル種別、シーン ID）
│   │   ├── renderer.js          256x240 オフスクリーン Canvas 描画エンジン
│   │   ├── font.js              ビットマップフォント（A-Z, a-z, 0-9, 記号）
│   │   ├── input.js             キーボード入力バッファリング
│   │   ├── titleScreen.js       タイトル / ゲームオーバー / クリア画面
│   │   ├── mapEngine.js         フィールド描画・カメラ・移動・エンカウント
│   │   ├── battleUI.js          戦闘画面・コマンドメニュー・演出
│   │   ├── shopUI.js            ショップ UI
│   │   ├── menuUI.js            ステータス / アイテムメニュー（フィールド）
│   │   └── gameData.js          タイル色・ステージ名・敵カラーの定義
│   └── wasm/                    ビルド出力先（.gitignore 対象）
│       ├── game.js              Emscripten グルーコード（自動生成）
│       └── game.wasm            WASM バイナリ（自動生成）
```

### 各ファイル詳細

#### C++ バックエンド

| ファイル | 行数目安 | 説明 |
|----------|---------|------|
| **Player.h/.cpp** | ~120 行 | HP/MP/ATK/DEF 管理、レベルアップ（EXP テーブル内蔵）、インベントリ（最大 5 枠）、装備管理、状態異常（ATK 半減デバフ）|
| **Enemy.h/.cpp** | ~80 行 | 12 種の敵を `EnemyDef` 構造体の静的配列で定義。ボスフラグ、全体攻撃・回復・状態攻撃の能力フラグを保持 |
| **Item.h/.cpp** | ~40 行 | 17 種のアイテムを静的配列で定義。種別（武器/防具/消耗品）、効果値、販売ステージを管理 |
| **Battle.h/.cpp** | ~250 行 | ダメージ計算式 `max(1, ATK/2 - DEF/4)`、プレイヤーコマンド実行（攻撃/魔法/アイテム/逃走）、敵 AI（ボスは全体攻撃・回復・状態攻撃を確率で選択）|
| **Shop.h/.cpp** | ~50 行 | ステージ別の商品リスト生成、購入（ゴールド消費＋インベントリ追加 or 装備）|
| **GameState.h/.cpp** | ~30 行 | シーン管理、プレイヤー・戦闘・マップ座標を一元管理するグローバル状態 |
| **MapData.h/.cpp** | ~100 行 | 30x15 タイルの 3 ステージ分マップ配列。歩行可否・エンカウント判定・開始座標の関数を提供 |
| **Bridge.cpp** | ~350 行 | 全 C++ 関数を `EMSCRIPTEN_BINDINGS` でエクスポート。JS → C++ の呼び出しと JSON レスポンスの生成を担当 |

#### JavaScript フロントエンド

| ファイル | 行数目安 | 説明 |
|----------|---------|------|
| **main.js** | ~80 行 | WASM ロード → 各モジュール初期化 → `requestAnimationFrame` ゲームループ → シーンルーティング |
| **renderer.js** | ~80 行 | オフスクリーン 256x240 Canvas への描画 API（矩形、テキスト、ウィンドウ枠）。フラッシュ・シェイク演出 |
| **font.js** | ~160 行 | 5x8 ピクセルのビットマップフォント。各文字を 8 バイトのビットマスク配列で定義 |
| **input.js** | ~40 行 | `keydown`/`keyup` イベントをバッファリング。フレーム単位で `consume()` して入力を取得 |
| **titleScreen.js** | ~120 行 | タイトルロゴ（剣の装飾付き）、点滅テキスト、ゲームオーバー画面、ゲームクリア画面 |
| **mapEngine.js** | ~170 行 | タイルマップ描画（色分け＋ディテール装飾）、カメラスクロール、プレイヤースプライト、HUD バー |
| **battleUI.js** | ~450 行 | 戦闘シーンの状態機械（イントロ→コマンド→アクション→敵ターン→勝利/敗北）、敵スプライト描画、タイピング演出 |
| **shopUI.js** | ~130 行 | ショップアイテム一覧表示、購入処理、所持金・装備ステータス表示 |
| **menuUI.js** | ~130 行 | フィールドメニュー（ステータス確認、アイテム使用）のオーバーレイ表示 |
| **gameData.js** | ~40 行 | タイル→色のマッピング、ステージ名、敵カラーの定義 |

---

## 6. 操作マニュアル

### 6.1 基本操作

| キー | 機能 |
|------|------|
| **矢印キー（↑↓←→）** | フィールド移動 / メニュー選択 |
| **Enter** または **Z** | 決定 / テキスト送り |
| **Escape** または **X** | キャンセル / メニューを開く・閉じる |

### 6.2 タイトル画面

- 「LEGEND OF THE HELLO WORLD」のロゴと「PRESS ENTER TO START」が表示されます
- **Enter** を押すとゲーム開始（ステージ 1 の草原にスポーン）

### 6.3 フィールド画面

- **矢印キー** でプレイヤー（青い騎士）を移動
- 草地を歩くとランダムエンカウントが発生します
- **Escape** でステータス / アイテムメニューを開きます

#### タイルの種類と意味

| 色 | タイル | 説明 |
|----|--------|------|
| 緑 | 草地 | 歩行可。敵が出現する |
| 濃緑 | 木 | 通行不可 |
| 青 | 水 | 通行不可 |
| 茶 | 山 | 通行不可 |
| 黄 | 道 | 歩行可。敵は出ない |
| 灰 / 肌色 | 村 / ショップ | 入るとショップ画面へ |
| 暗灰 | 洞窟入口 | ステージ 2 への入口 |
| 灰 (明) | 床 | 歩行可。敵が出現する（洞窟/城内） |
| 暗灰 / 明灰 | 階段 | ステージ間移動 |
| 赤 | ボスタイル | 踏むとボス戦開始 |

### 6.4 戦闘画面

画面上部に敵スプライト、下部にコマンドウィンドウが表示されます。

#### コマンド一覧

| コマンド | 効果 |
|---------|------|
| **Attack** | 選択した敵に物理攻撃。ダメージ = `ATK/2 - 敵DEF/4` |
| **Magic** | サブメニューから魔法を選択 |
| → Attack Magic | MP 10 消費。1.5 倍の攻撃力で魔法ダメージ |
| → Heal Magic | MP 15 消費。HP を `30 + LV×2` 回復 |
| **Item** | インベントリから消耗品を使用 |
| **Run** | 逃走を試みる（成功率 = `50% + (自LV - 敵LV) × 10%`） |

- 敵が複数いる場合、Attack / Attack Magic 選択後にターゲット選択画面が表示されます
- ボス戦では逃走不可

#### 戦闘演出

- プレイヤーが攻撃 → 画面が白くフラッシュ
- 敵が攻撃 → 画面が揺れる
- テキストは 1 文字ずつタイピング表示

### 6.5 ショップ画面

村タイル（灰色の家）またはショップタイル（肌色）に入ると開きます。

- **↑↓** でアイテム選択
- **Enter** で購入
- 武器・防具は購入と同時に装備されます（以前の装備は上書き）
- 消耗品はインベントリに追加（最大 5 枠）
- **Escape** でショップを出る

### 6.6 メニュー画面（フィールド）

フィールドで **Escape** を押すと開きます。

- **Status**: 現在の LV / HP / MP / ATK / DEF / EXP / Gold を確認
- **Items**: 所持アイテム一覧を表示。消耗品を選択して使用可能（HP/MP 回復、状態回復）
- **Escape** でメニューを閉じる

### 6.7 ゲームフロー攻略ガイド

```
ステージ 1: 旅立ちの草原
  ├─ スタート地点（左端）
  ├─ 村（中央やや左）でショップ → 武器・防具を購入
  ├─ 草原でスライム・コウモリ等を倒して LV 8〜10 まで育成
  └─ 東端の洞窟入口 → ステージ 2 へ
          │
ステージ 2: 灼熱の洞窟
  ├─ エンカウント率が高い（15%/歩）
  ├─ ショップタイル（右奥）で鉄/鋼の装備を購入
  ├─ LV 15〜20 まで育成
  ├─ ボスタイル（赤）→ フレイムドラゴン戦
  │     HP 200, 全体攻撃あり
  │     回復魔法とやくそうを活用
  └─ 撃破後、階段 → ステージ 3 へ
          │
ステージ 3: 魔王の城
  ├─ 強敵揃い（デーモンナイト、シャドウ等）
  ├─ ショップタイルでドラゴンメイル / ほのおのけんを購入
  ├─ LV 30〜35 まで育成
  ├─ ボスタイル → デーモン・ロード戦
  │     HP 500, 全体攻撃 + ATK 半減 + 自己回復
  │     まんたんやくと MP ポーション必須
  └─ 撃破 → ゲームクリア画面
```

### 6.8 ゲームオーバーとリスタート

- HP が 0 になると「GAME OVER」画面が表示されます
- **Enter** を押すとタイトル画面に戻ります
- セーブ機能はないため、最初からやり直しになります

---

## 7. ゲームデータ一覧

### 7.1 プレイヤー初期ステータス

| パラメータ | 初期値 | レベルアップ時の上昇量 |
|-----------|--------|---------------------|
| HP | 60 | +5 / LV |
| MP | 30 | +3 / LV |
| ATK | 40 | +3 / LV |
| DEF | 30 | +3 / LV |
| Gold | 100 | - |
| 最大レベル | 50 | - |

### 7.2 敵ステータス

#### ステージ 1: 旅立ちの草原（エンカウント率 8%/歩）

| 敵名 | HP | ATK | DEF | EXP | Gold |
|------|-----|-----|-----|-----|------|
| Slime | 12 | 20 | 8 | 5 | 3 |
| Bat | 10 | 24 | 4 | 7 | 5 |
| Goblin | 18 | 28 | 12 | 12 | 8 |
| Wolf | 15 | 32 | 8 | 10 | 6 |

#### ステージ 2: 灼熱の洞窟（エンカウント率 15%/歩）

| 敵名 | HP | ATK | DEF | EXP | Gold |
|------|-----|-----|-----|-----|------|
| Fire Snake | 35 | 60 | 28 | 25 | 20 |
| Golem | 55 | 50 | 48 | 35 | 30 |
| Dark Mage | 30 | 70 | 20 | 30 | 25 |
| **Flame Dragon (Boss)** | **200** | **80** | **40** | **300** | **200** |

#### ステージ 3: 魔王の城（エンカウント率 12%/歩）

| 敵名 | HP | ATK | DEF | EXP | Gold |
|------|-----|-----|-----|-----|------|
| Demon Knight | 70 | 110 | 60 | 60 | 50 |
| Shadow | 50 | 130 | 30 | 55 | 45 |
| Dark Sorcerer | 60 | 120 | 40 | 65 | 55 |
| **Demon Lord (Boss)** | **500** | **150** | **80** | **-** | **-** |

#### ボス特殊行動

| ボス | 通常攻撃 | 全体攻撃 | 自己回復 | 状態攻撃 |
|------|---------|---------|---------|---------|
| Flame Dragon | 60% | 25%（1.5 倍） | HP30%以下で 15%（40HP） | - |
| Demon Lord | 40% | 25%（1.5 倍） | HP30%以下で 15%（80HP） | 20%（ATK 半減 3 ターン） |

### 7.3 武器・防具・アイテム

#### 武器

| ID | 名前 | ATK 上昇 | 価格 | 販売ステージ |
|----|------|---------|------|------------|
| 0 | Ki no Tsurugi（きのつるぎ） | +5 | 50G | 1 |
| 1 | Dou no Tsurugi（どうのつるぎ） | +12 | 200G | 1 |
| 2 | Tetsu no Tsurugi（てつのつるぎ） | +22 | 600G | 2 |
| 3 | Hagane no Tsurugi（はがねのつるぎ） | +35 | 1,500G | 2 |
| 4 | Honoo no Ken（ほのおのけん） | +50 | 4,000G | 3 |
| 5 | Seinaru Ken（せいなるけん） | +70 | 10,000G | 3 |

#### 防具

| ID | 名前 | DEF 上昇 | 価格 | 販売ステージ |
|----|------|---------|------|------------|
| 6 | Kawa no Yoroi（かわのよろい） | +5 | 40G | 1 |
| 7 | Kusari Katabira（くさりかたびら） | +12 | 250G | 1 |
| 8 | Tetsu no Yoroi（てつのよろい） | +22 | 700G | 2 |
| 9 | Hagane no Yoroi（はがねのよろい） | +35 | 1,800G | 2 |
| 10 | Dragon Mail（ドラゴンメイル） | +50 | 5,000G | 3 |
| 11 | Mithril Armor（ミスリルアーマー） | +70 | 12,000G | 3 |

#### 消耗品

| ID | 名前 | 効果 | 価格 | 販売ステージ |
|----|------|------|------|------------|
| 12 | Yakusou（やくそう） | HP +30 | 10G | 全ステージ |
| 13 | Jou Yakusou（じょうやくそう） | HP +80 | 40G | 2, 3 |
| 14 | Dokukeshi（どくけし） | 状態異常回復 | 8G | 全ステージ |
| 15 | MP Potion（MP ポーション） | MP +20 | 30G | 全ステージ |
| 16 | Mantan Yaku（まんたんやく） | HP +200 | 150G | 3 |

### 7.4 経験値テーブル（抜粋）

| レベル | 累積 EXP | レベル | 累積 EXP | レベル | 累積 EXP |
|--------|---------|--------|---------|--------|---------|
| 2 | 15 | 11 | 1,200 | 21 | 12,000 |
| 3 | 40 | 12 | 1,600 | 22 | 14,000 |
| 5 | 140 | 15 | 3,400 | 25 | 23,000 |
| 7 | 330 | 17 | 5,200 | 28 | 36,500 |
| 10 | 880 | 20 | 9,500 | 30 | 48,000 |

LV 31 以降は 1 レベルごとに +7,000 EXP ずつ増加（最大 LV 50）。

---

## 8. 戦闘計算式

| 項目 | 計算式 |
|------|--------|
| 物理ダメージ | `max(1, ATK/2 - DEF/4)` ※ ±10% のランダム振れ幅あり |
| 魔法ダメージ | `max(1, (ATK*1.5)/2 - DEF/4)` |
| 回復魔法 | `30 + LV × 2` HP 回復 |
| 逃走成功率 | `50% + (自LV - 平均敵LV) × 10%`（10%〜90% にクランプ） |
| 複数敵出現 | 自 LV が敵の推定 LV より 3 以上高い場合、40% の確率で 2 体出現 |

---

## 9. 次回に向けた改善ポイント

### 9.1 ゲーム機能

- [ ] **BGM / 効果音の追加**: Web Audio API で 8bit 風のチップチューンを実装
- [ ] **セーブ / ロード機能**: `localStorage` にゲーム状態を保存・復元
- [ ] **NPC と会話**: 村に NPC を配置し、ヒントやストーリーを提供
- [ ] **状態異常の拡充**: 毒（毎ターン HP 減少）、麻痺（行動不能）、眠り等の追加
- [ ] **防御コマンド**: 1 ターン DEF を 2 倍にする「ぼうぎょ」コマンドの追加
- [ ] **経験値 / ゴールドのバランス調整**: プレイテストに基づく微調整

### 9.2 ビジュアル / UX

- [ ] **スプライトシートの導入**: ハードコードされたピクセルアートを画像ファイルに移行
- [ ] **アニメーション強化**: 移動時の歩行アニメ、戦闘中の攻撃モーション
- [ ] **日本語フォント対応**: ひらがな / カタカナ / 漢字のビットマップフォント追加
- [ ] **マップのバリエーション**: 宝箱、扉、スイッチなどのギミックタイル追加
- [ ] **レスポンシブ対応**: 画面サイズに応じた Canvas スケーリング

### 9.3 技術的改善

- [ ] **CMake ビルドシステム**: 大規模化に備えた CMakeLists.txt の導入
- [ ] **ユニットテスト**: C++ 側のダメージ計算・レベルアップロジックのテスト
- [ ] **TypeScript 移行**: JS を TypeScript に書き換えて型安全性を確保
- [ ] **パフォーマンス最適化**: JSON パースの頻度削減（バッチ取得等）
- [ ] **モバイル対応**: タッチ入力・バーチャルパッドの実装

---

## 10. 運用面でのネクストアクション

### 10.1 デプロイ

| アクション | 詳細 |
|-----------|------|
| **GitHub Pages** | `web/` フォルダと `index.html` を GitHub Pages でホスティング可能。`build.sh` でビルド後、`web/wasm/` の成果物もコミットする |
| **CI/CD** | GitHub Actions で `build.sh` を実行し、WASM を自動ビルド → デプロイするパイプラインを構築 |
| **CDN 配信** | WASM ファイルの MIME タイプ `application/wasm` をサーバー側で設定 |

### 10.2 品質管理

| アクション | 詳細 |
|-----------|------|
| **通しプレイテスト** | タイトル → 全 3 ステージクリアまでの全フローを確認 |
| **エッジケーステスト** | MP 0 で魔法使用、インベントリ満杯で購入、ゴールド不足で購入、LV 50 での EXP 獲得 |
| **ブラウザ互換テスト** | Chrome / Firefox / Edge での動作確認 |
| **バランスシート管理** | 敵ステータス・アイテム価格を外部データ（JSON / CSV）に分離して調整しやすくする |

### 10.3 ドキュメント

| アクション | 詳細 |
|-----------|------|
| **WASM Bridge API ドキュメント** | `Bridge.cpp` のエクスポート関数一覧と JSON レスポンス形式の仕様書作成 |
| **ゲームデザインドキュメント** | バランス設計の意図（ダメージ試算表含む）を記録 |
| **CHANGELOG** | バージョン管理とリリースノートの記録開始 |

---

## 11. ライセンス

MIT Lisence
